---
title: "`ambrosia`: User Tutorial"
author: "Kanishka Narayan"
date: "2020-10-08"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{`ambrosia`: User Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
#load libraries
library(ambrosia)
library(dplyr)
library(ggplot2)
library(knitr)
```

## Example 1: Get parameters
```{r}

c(1.28,1.14,-0.19,0.21,-0.33,0.5,0.1,16,5.06,100,20)->original_param_vector

parameter_names<-c('A_s', 'A_n', 'xi_ss', 'xi_cross', 'xi_nn', 'nu1_n',
                     'lambda_s', 'k_s', 'Pm', 'psscl','pnscl')
parameter_data<-data.frame(parameter_names,original_param_vector)

tmp_param<-vec2param(original_param_vector)

kable(parameter_data ,col.names = c("parameter_name","value"),format = "pandoc")

```

## Example 2: Calculate food demand
```{r}

Test_Data<-data.frame(Y=seq(0.1,30, by=0.1))
#Add sample values of Ps and Pn. These are in accordance with Robert's original samp,e
Test_Data %>% mutate(Ps=0.1,Pn=0.2)->Test_Data




Food_Demand<-food.dmnd(Test_Data$Ps,Test_Data$Pn,Test_Data$Y,params=tmp_param)
```

## Example 3: Visualize food demand
```r
Food_Demand$Total_Demand<-Food_Demand$Qs+Food_Demand$Qn
Food_Demand$Y<-seq(0.1,30, by=0.1)


g<-ggplot()+
    geom_line(data=Food_Demand,aes(x=Y,y=Qs,color="Staple Demand"))+
    geom_line(data=Food_Demand,aes(x=Y,y=Qn,color="Non Staple Demand"))+
    xlab("GDP per capita in thousand USD" )+
    ylab("Thousand calories")
    # ggtitle("Calculated values of food demand using model parameters")+
    # labs(subtitle="Prices are set to 0.1 for Staples and 0.2 for Non-staples. This is the same as fig 1 from Edmonds et al")
```
![](example_3.png){width=50% height=50%} 

## Example 4: Visualize budget shares
```r

budget_shares <- Food_Demand %>% 
                 mutate(share_of_staples=alpha.s*100,
                        share_of_non_staples=alpha.n*100,
                        share_of_materials=alpha.m*100)

budget_shares$Y<-seq(0.1,30, by=0.1)

g<-ggplot()+
  geom_line(data=budget_shares,aes(x=Y,y=share_of_staples,color="Staple share"))+
  geom_line(data=budget_shares,aes(x=Y,y=share_of_non_staples,color="Non Staple share"))+
  #geom_line(data=budget_shares,aes(x=Y,y=share_of_materials,color="Materials share"))+
    xlab("GDP per capita in thousand USD" )+
    ylab("Percent of Income")
    # ggtitle("Calculated budget shares using food demand parameters")+
    # labs(subtitle="Prices are set to 0.1 for Staples and 0.2 for Non-staples")

```
![](example_4.png){width=50% height=50%} 

## Calculate income elasticities
```r
Food_Demand$eta.s <- tmp_param$yfunc[[1]](Y=Food_Demand$Y,FALSE)
Food_Demand$eta.n <- tmp_param$yfunc[[2]](Y=Food_Demand$Y,FALSE)

g<-ggplot()+
  geom_line(data=Food_Demand,aes(x=Y,y=eta.s,color="Income elasticities for staples"))+
  geom_line(data=Food_Demand,aes(x=Y,y=eta.n,color="Income elasticities for non-staples"))+
  #geom_line(data=budget_shares,aes(x=Y,y=share_of_materials,color="Materials share"))+
    xlab("GDP per capita in thousand USD" )+
    ylab("Ealsticity value")
    # ggtitle("Calculated income elasticities for each level of income")+
    # labs(subtitle=paste0("Income elasticity parameter value for staples and non-staples are ",original_param_vector[7]," ,",original_param_vector[6]," respectively"))

```
![](example_5.png){width=50% height=50%} 

## Calculate price elasticities
```r
Food_Demand$staple_price_elasticity <- calc1eps(Food_Demand$alpha.s,Food_Demand$alpha.n,Food_Demand$eta.s,Food_Demand$eta.n,tmp_param$xi)[1:300]
Food_Demand$eta.n <- tmp_param$yfunc[[2]](Y=Food_Demand$Y,FALSE)

Food_Demand$non_staple_price_elasticity <- calc1eps(Food_Demand$alpha.s,Food_Demand$alpha.n,Food_Demand$eta.s,Food_Demand$eta.n,tmp_param$xi)[901:1200]
Food_Demand$eta.n <- tmp_param$yfunc[[2]](Y=Food_Demand$Y,FALSE)

g<-ggplot()+
  geom_line(data=Food_Demand,aes(x=Y,y=staple_price_elasticity,color="Staple price elasticity"))+
  geom_line(data=Food_Demand,aes(x=Y,y=non_staple_price_elasticity,color="Non staple price elasticity"))+
  #geom_line(data=budget_shares,aes(x=Y,y=share_of_materials,color="Materials share"))+
    xlab("GDP per capita in thousand USD" )+
    ylab("Ealsticity value")
    # ggtitle("Calculated price elasticities for each level of income")+
    # labs(subtitle=paste0("price elasticity parameter value for staples and non-staples are ",original_param_vector[3]," ,",original_param_vector[5]," respectively"))

```
![](example_6.png){width=50% height=50%} 


## Now let's calculate some model parameters
### Warning: This might take a long time to run since we are using the entire training dataset
```r
Sample_Data <- read.csv("Training_Data.csv") 

temp_data <- create_dataset_for_parameter_fit(data=Sample_Data,min_clusters = 300,min_price_pd = 20,min_cal_fd = 1700) 
```

## Analyze distribution of observational error for non-staples
```r
g<-ggplot()+
   geom_histogram(data=temp_data,aes(x=sig2Qn),bins = 40)+
   xlab("Observational error within clusters for non-staples")
   # ggtitle("Distribution of observational error for non-staples for selected sample dataset")
```
![](example_7.png){width=50% height=50%} 

## Analyze distribution of observational error for staples

```r
g<-ggplot()+
   geom_histogram(data=temp_data,aes(x=sig2Qs),bins = 40)+
   xlab("Observational error within clusters for staples")
   #ggtitle("Distribution of observational error for staples for selected sample dataset")
```
![](example_8.png){width=50% height=50%} 

